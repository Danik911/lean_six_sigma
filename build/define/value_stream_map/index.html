<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SimplePharma Value Stream Map</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    /* Debug styles */
    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 9999;
      font-size: 12px;
    }
    
    /* Process node styles */
    .process-node {
      position: absolute;
      width: 160px;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    
    .process-node:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .inventory-node {
      position: absolute;
      width: 60px;
      height: 60px;
      transform: translate(-50%, -50%) rotate(45deg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    
    .inventory-node-content {
      transform: rotate(-45deg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    /* Waste icon styles */
    .waste-icon {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      z-index: 15; /* Increased z-index */
      transition: transform 0.2s ease; /* Added for hover effect */
    }
    
    /* Improvement icon styles */
    .improvement-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 16; /* Increased z-index */
      border: 2px solid white;
      transition: transform 0.2s ease;
    }
    
    .improvement-icon:hover {
      transform: scale(1.1);
    }
    
    /* Counter-rotate icons inside inventory nodes */
    .inventory-node .waste-icon,
    .inventory-node .improvement-icon {
      transform: rotate(-45deg); /* Counter the node's rotation */
    }
    
    .inventory-node .improvement-icon:hover {
       transform: rotate(-45deg) scale(1.1); /* Combine rotation and scale */
    }
    
    .waste-tooltip, .improvement-tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%); /* Keep this for centering */
      transform-origin: center bottom; /* Set origin for potential rotation */
      margin-bottom: 8px;
      padding: 6px 10px;
      background-color: rgba(0,0,0,0.85); /* Slightly darker */
      color: white;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 50; /* Significantly increased z-index */
      pointer-events: none;
    }
    
    /* Add rule for counter-rotating tooltips on rotated parents */
    .waste-tooltip.tooltip-needs-unrotate,
    .improvement-tooltip.tooltip-needs-unrotate {
      transform: translateX(-50%) rotate(-45deg);
    }

    .waste-icon:hover .waste-tooltip,
    .improvement-icon:hover .improvement-tooltip {
      display: block;
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 42rem;
      margin: 0 1rem;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    /* Process flow arrows */
    .process-arrow {
      position: absolute;
      height: 2px;
      background-color: #666;
      z-index: 1;
    }
    
    .process-arrow::after {
      content: '';
      position: absolute;
      right: 0;
      top: -4px;
      width: 0;
      height: 0;
      border-left: 10px solid #666;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
    }
    
    /* Connection line styles */
    .connection-line {
      position: absolute;
      height: 2px; /* Line thickness */
      background-color: #888; /* Line color */
      transform-origin: 0 50%; /* Rotate around the starting point */
      z-index: 5; /* Ensure lines are behind nodes but above background */
    }
  </style>
</head>
<body>
  <!-- Debug container to show load status -->
  <div id="debug-container" class="debug-info">Loading React app...</div>
  
  <div id="root"></div>
  
  <!-- Load the improvements data -->
  <script src="improvements.js"></script>
  
  <!-- Load the App component -->
  <script type="text/babel">
    // Define waste icons and descriptions
    const wasteIcons = {
      motion: { icon: 'üîÑ', name: 'Motion Waste', color: 'bg-purple-200 border-purple-500' },
      waiting: { icon: '‚è≥', name: 'Waiting Waste', color: 'bg-blue-200 border-blue-500' },
      transportation: { icon: 'üöö', name: 'Transportation Waste', color: 'bg-green-200 border-green-500' },
      defects: { icon: '‚ùå', name: 'Defects Waste', color: 'bg-red-200 border-red-500' },
      overprocessing: { icon: '‚öôÔ∏è', name: 'Overprocessing Waste', color: 'bg-yellow-200 border-yellow-500' },
      inventory: { icon: 'üì¶', name: 'Inventory Waste', color: 'bg-orange-200 border-orange-500' },
      talent: { icon: 'üë§', name: 'Talent Waste', color: 'bg-indigo-200 border-indigo-500' }
    };
    
    // Basic simplified ValueStreamMap component
    const ValueStreamMap = () => {
      // Basic state
      const [viewMode, setViewMode] = React.useState('current'); // current, improved, ideal
      const [selectedProcess, setSelectedProcess] = React.useState(null);
      const [showInfoModal, setShowInfoModal] = React.useState(false);
      const [metrics, setMetrics] = React.useState({
        totalLeadTime: 85.7,
        valueAddedTime: 12.4,
        processCycleEfficiency: 14.5,
        accuracyRate: 76.5
      });
      const [connectionStyles, setConnectionStyles] = React.useState([]); // State for line styles
      const mapContainerRef = React.useRef(null); // Ref for map container

      // Waste data based on lean waste analysis
      const wasteData = {
        'process-receiving': {
          wastes: [
            { type: 'motion', data: 'Unnecessary movement during receiving' },
            { type: 'waiting', data: 'Waiting for inspection approvals' }
          ]
        },
        'process-storage': {
          wastes: [
            { type: 'inventory', data: 'Long storage (72hrs avg)' },
            { type: 'transportation', data: 'Moving between building areas' }
          ]
        },
        'process-distribution': {
          wastes: [
            { type: 'transportation', data: 'Moving between shop floor & warehouses' },
            { type: 'motion', data: 'Unnecessary movement between floors' }
          ]
        },
        'process-shopfloor': {
          wastes: [
            { type: 'inventory', data: 'Excess inventory on shelves' },
            { type: 'talent', data: 'Staff skills misalignment' }
          ]
        },
        'process-stocktake': {
          wastes: [
            { type: 'defects', data: '23.5% error rate, 10.19% avg magnitude' },
            { type: 'waiting', data: '1hr lunch breaks, waiting for scanners' },
            { type: 'overprocessing', data: 'Double counting, sticky notes' },
            { type: 'motion', data: 'Movement during counting process' },
            { type: 'talent', data: 'Underutilization of advanced-trained staff' }
          ]
        },
        'inventory-receiving': {
          wastes: [
            { type: 'inventory', data: 'WIP waiting time: 3 hours' }
          ],
          showLabel: true
        },
        'inventory-storage': {
          wastes: [
            { type: 'inventory', data: 'Storage waiting time: 72 hours' }
          ],
          showLabel: true
        },
        'inventory-transit': {
          wastes: [
            { type: 'transportation', data: 'Moving between shop floor & warehouses' }
          ],
          showLabel: true
        }
      };
      
      // Process data based on vfm.txt with increased spacing and added third supplier (VitaFast)
      const processes = [
        // Suppliers
        {
          id: 'supplier-meddev',
          name: 'MedDev',
          type: 'supplier',
          metrics: { deliveryFrequency: 'Daily', leadTime: '1-2 days' },
          details: 'Medical device supplier',
          position: { x: 8, y: 25 } 
          // Removed nodeWidth/Height, calculate based on position only for now
        },
        {
          id: 'supplier-drugseek',
          name: 'DrugSeek',
          type: 'supplier',
          metrics: { deliveryFrequency: '3 times/week', leadTime: '1 day' },
          details: 'Pharmaceutical supplier',
          position: { x: 8, y: 50 }
        },
        {
          id: 'supplier-vitafast',
          name: 'VitaFast',
          type: 'supplier',
          metrics: { deliveryFrequency: '2 times/week', leadTime: '2-3 days' },
          details: 'Miscellaneous goods supplier',
          position: { x: 8, y: 75 }
        },
        
        // Processes - increased x-axis spacing
        {
          id: 'process-receiving',
          name: 'Receiving',
          type: 'process',
          metrics: { oeeUtilization: 92, accuracy: 94, processTime: 3.5 },
          details: 'Trucks arrive at inward goods zone between buildings',
          position: { x: 25, y: 35 }
        },
        {
          id: 'process-storage',
          name: 'Storage',
          type: 'process',
          metrics: { oeeUtilization: 88, accuracy: 76.5, processTime: 0.7, waitTime: 72 },
          details: 'Medical devices stored in main warehouse (3rd floor)',
          position: { x: 42, y: 35 }
        },
        {
          id: 'process-distribution',
          name: 'Internal Distribution',
          type: 'process',
          metrics: { oeeUtilization: 85, accuracy: 82, processTime: 1.1 },
          details: 'Staff transfers products between warehouses and shop',
          position: { x: 59, y: 35 }
        },
        {
          id: 'process-shopfloor',
          name: 'Shop Floor',
          type: 'process',
          metrics: { oeeUtilization: 82, accuracy: 93, processTime: 0.1 },
          details: 'Products are arranged on shelves and sold to customers',
          position: { x: 76, y: 35 }
        },
        {
          id: 'process-stocktake',
          name: 'Stock Take',
          type: 'process',
          metrics: { oeeUtilization: 65, accuracy: 76.5, processTime: 6 },
          details: 'Quarterly stock count process',
          position: { x: 76, y: 65 }
        },
        
        // Customer
        {
          id: 'customer',
          name: 'Customers',
          type: 'customer',
          metrics: { satisfaction: 82 },
          details: 'End customers purchasing products',
          position: { x: 92, y: 35 }
        },
        
        // Inventory nodes - also adjusted spacing
        {
          id: 'inventory-receiving',
          name: 'WIP',
          type: 'inventory',
          metrics: { waitTime: 3 },
          details: 'Work in progress after receiving',
          position: { x: 33.5, y: 35 }
        },
        {
          id: 'inventory-storage',
          name: 'Storage',
          type: 'inventory',
          metrics: { waitTime: 72 },
          details: 'Stored inventory',
          position: { x: 50.5, y: 35 }
        },
        {
          id: 'inventory-transit',
          name: 'Transit',
          type: 'inventory',
          metrics: { waitTime: 5 },
          details: 'In-transit inventory',
          position: { x: 67.5, y: 35 }
        }
      ];
      
      // Get color based on process type and metrics
      const getProcessColor = (process) => {
        if (process.type === 'supplier') return 'bg-blue-100 border-blue-500';
        if (process.type === 'customer') return 'bg-green-100 border-green-500';
        if (process.type === 'inventory') return 'bg-yellow-100 border-yellow-500';
        
        // For process nodes, color based on OEE/utilization
        if (process.metrics && process.metrics.oeeUtilization) {
          if (process.metrics.oeeUtilization >= 90) return 'bg-green-100 border-green-500';
          if (process.metrics.oeeUtilization >= 80) return 'bg-blue-100 border-blue-500';
          if (process.metrics.oeeUtilization >= 70) return 'bg-yellow-100 border-yellow-500';
          return 'bg-red-100 border-red-500';
        }
        
        return 'bg-gray-100 border-gray-500';
      };
      
      // Handle process click
      const handleProcessClick = (process) => {
        setSelectedProcess(process);
      };
      
      // Create the waste icons for a process
      const createWasteIcons = (process) => {
        if (!wasteData[process.id] || viewMode !== 'current') return null;
        
        return wasteData[process.id].wastes.map((waste, index) => {
          const wasteInfo = wasteIcons[waste.type];
          if (!wasteInfo) return null;
          
          // Position icons above the nodes (outside)
          const top = process.type === 'inventory' ? -45 : -35; // Adjusted vertical position slightly
          // Calculate horizontal offset for multiple icons - Increased spacing
          const iconSpacing = 32; // Increased from 28
          const offset = index * iconSpacing - ((wasteData[process.id].wastes.length - 1) * (iconSpacing / 2));
          
          // Determine if counter-rotation is needed for the tooltip
          const tooltipClass = process.type === 'inventory' ? 'waste-tooltip tooltip-needs-unrotate' : 'waste-tooltip';

          return (
            <div 
              key={index}
              className={`waste-icon ${wasteInfo.color}`}
              style={{
                top: `${top}px`, 
                left: `calc(50% + ${offset}px)`,
                // transform: 'translateX(-50%)' // This might interfere with inventory rotation fix, handled by CSS
              }}
            >
              <span>{wasteInfo.icon}</span>
              {/* Apply conditional class here */}
              <div className={tooltipClass}>
                <strong>{wasteInfo.name}</strong>
                {waste.data && <div>{waste.data}</div>}
              </div>
            </div>
          );
        });
      };
      
      // Create the improvement icons for a process
      const createImprovementIcons = (process) => {
        if (viewMode === 'current' || !improvementsData[process.id]) return null;
        
        return improvementsData[process.id].improvements.map((improvement, index) => {
          const impInfo = improvementIcons[improvement.type];
          if (!impInfo) return null;
          
          // Position improvement icons below the nodes
          const bottom = process.type === 'inventory' ? -45 : -35; // Adjusted vertical position slightly
          // Calculate horizontal offset for multiple icons - Increased spacing
          const iconSpacing = 32; // Increased from 30
          const offset = index * iconSpacing - ((improvementsData[process.id].improvements.length - 1) * (iconSpacing / 2));
          
          // Determine if counter-rotation is needed for the tooltip
          const tooltipClass = process.type === 'inventory' ? 'improvement-tooltip tooltip-needs-unrotate' : 'improvement-tooltip';

          return (
            <div 
              key={`imp-${index}`}
              className={`improvement-icon ${impInfo.color}`}
              style={{
                bottom: `${bottom}px`, 
                left: `calc(50% + ${offset}px)`,
                // transform: 'translateX(-50%)' // This might interfere with inventory rotation fix, handled by CSS
              }}
            >
              <span>{impInfo.icon}</span>
              <div className={tooltipClass}>
                <strong>{impInfo.name}</strong>
                {improvement.data && <div>{improvement.data}</div>}
              </div>
            </div>
          );
        });
      };
      
      // Get process details based on view mode
      const getProcessDetails = (process) => {
        if (viewMode === 'improved' && futureStateChanges[process.id]) {
          return {
            ...process,
            metrics: {
              ...process.metrics,
              ...futureStateChanges[process.id].metrics
            },
            details: futureStateChanges[process.id].details || process.details
          };
        } else if (viewMode === 'ideal' && idealStateChanges[process.id]) {
          return {
            ...process,
            metrics: {
              ...process.metrics,
              ...idealStateChanges[process.id].metrics
            },
            details: idealStateChanges[process.id].details || process.details
          };
        }
        
        return process;
      };
      
      // Render process details panel
      const renderProcessDetails = () => {
        if (!selectedProcess) return null;
        
        const processDetails = getProcessDetails(selectedProcess);
        const nodeElement = document.querySelector(`[data-process-id="${selectedProcess.id}"]`); // Need to add data-process-id to nodes
        
        let panelStyle = {
          position: 'absolute',
          zIndex: 20,
          maxWidth: '400px', // Adjusted max width slightly
          // Default position if node not found
          bottom: '5rem', 
          right: '1.5rem'
        };

        if (nodeElement) {
          const nodeRect = nodeElement.getBoundingClientRect();
          const containerRect = nodeElement.offsetParent.getBoundingClientRect(); // Get container bounds

          // Calculate position relative to the node, trying to place it to the right first
          let top = nodeRect.top - containerRect.top; // Align top with node top initially
          let left = nodeRect.right - containerRect.left + 15; // 15px offset to the right

          // Basic boundary check (simplified) - Check if it goes off right edge
          if (left + 400 > containerRect.width) { // Use panel max width for check
            left = nodeRect.left - containerRect.left - 400 - 15; // Place to the left
          }
          // Basic boundary check - Check if it goes off bottom edge
          // This needs panel height, which is dynamic. Let's keep it simple and adjust top slightly if needed.
          if (top + 200 > containerRect.height) { // Assuming max height ~200px
             top = containerRect.height - 220; // Place near bottom edge
          }
          // Ensure it doesn't go off the top or left
          if (top < 10) top = 10;
          if (left < 10) left = 10;


          panelStyle = {
            ...panelStyle,
            top: `${top}px`,
            left: `${left}px`,
            bottom: 'auto', // Override fixed bottom/right
            right: 'auto'
          };
        }
        
        return (
          <div className="bg-white border rounded shadow-lg p-4" style={panelStyle}>
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-lg font-semibold">{processDetails.name}</h3>
              <button 
                onClick={() => setSelectedProcess(null)}
                className="text-gray-500 hover:text-gray-700"
              >
                X
              </button>
            </div>
            
            <div className="mb-3">
              <p className="text-sm text-gray-600">{processDetails.details}</p>
            </div>
            
            {processDetails.metrics && (
              <div className="mb-3">
                <h4 className="font-medium mb-1">Metrics:</h4>
                <div className="grid grid-cols-2 gap-2">
                  {Object.entries(processDetails.metrics).map(([key, value]) => (
                    <div key={key} className="text-sm">
                      <span className="font-medium capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}:</span> {value}
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {viewMode === 'current' && wasteData[processDetails.id] && (
              <div>
                <h4 className="font-medium mb-1">Identified Wastes:</h4>
                <div className="space-y-2">
                  {wasteData[processDetails.id].wastes.map((waste, index) => {
                    const wasteInfo = wasteIcons[waste.type];
                    return (
                      <div key={index} className="flex items-center gap-2 text-sm">
                        <span className={`inline-block ${wasteInfo.color} rounded-full p-1`}>
                          {wasteInfo.icon}
                        </span>
                        <div>
                          <div className="font-medium">{wasteInfo.name}</div>
                          <div className="text-gray-600">{waste.data}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {(viewMode === 'improved' || viewMode === 'ideal') && improvementsData[processDetails.id] && (
              <div>
                <h4 className="font-medium mb-1">Implemented Improvements:</h4>
                <div className="space-y-2">
                  {improvementsData[processDetails.id].improvements.map((improvement, index) => {
                    const impInfo = improvementIcons[improvement.type];
                    return (
                      <div key={index} className="flex items-center gap-2 text-sm">
                        <span className={`inline-block ${impInfo.color} rounded-full p-1`}>
                          {impInfo.icon}
                        </span>
                        <div>
                          <div className="font-medium">{impInfo.name}</div>
                          <div className="text-gray-600">{improvement.data}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        );
      };
      
      // Render info modal
      const renderInfoModal = () => {
        if (!showInfoModal) return null;
        
        return (
          <div className="modal-overlay">
            <div className="modal-content">
              <div className="p-4 border-b flex justify-between items-center">
                <h2 className="text-xl font-semibold">
                  SimplePharma Value Stream Map
                </h2>
                <button 
                  onClick={() => setShowInfoModal(false)}
                  className="text-gray-500 hover:text-gray-700"
                >
                  X
                </button>
              </div>
              
              <div className="p-6 max-h-[70vh] overflow-y-auto">
                <div className="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                  <h3 className="font-semibold mb-2">About this Value Stream Map</h3>
                  <p className="text-sm">
                    This value stream map visualizes the flow of materials and information through SimplePharma's
                    operations, from suppliers to customers. It highlights key processes, wait times, metrics,
                    and waste categories to identify opportunities for improvement.
                  </p>
                </div>
                
                <h3 className="font-semibold mb-2">How to Use this Map</h3>
                <ul className="space-y-2 text-sm mb-4">
                  <li>Click on any process node to see detailed information</li>
                  <li>Use the view mode toggles to switch between Current, Improved, and Ideal states</li>
                  <li>Review the overall metrics to understand system performance</li>
                  <li>Hover over waste icons (üîÑ, ‚è≥, etc.) to see waste details</li>
                  <li>In the improved and ideal states, hover over improvement icons (üì∂, ü§ñ, etc.) to see implemented improvements</li>
                </ul>
                
                <h3 className="font-semibold mb-2">Legend</h3>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="flex items-center p-2 border rounded">
                    <div className="w-6 h-6 bg-blue-100 border-2 border-blue-500 rounded flex items-center justify-center mr-2">
                    </div>
                    <span className="text-sm">Supplier</span>
                  </div>
                  <div className="flex items-center p-2 border rounded">
                    <div className="w-6 h-6 bg-green-100 border-2 border-green-500 rounded flex items-center justify-center mr-2">
                    </div>
                    <span className="text-sm">Customer</span>
                  </div>
                  <div className="flex items-center p-2 border rounded">
                    <div className="w-6 h-6 bg-blue-100 border-2 border-blue-500 rounded flex items-center justify-center mr-2">
                    </div>
                    <span className="text-sm">Operation Process</span>
                  </div>
                  <div className="flex items-center p-2 border rounded">
                    <div className="w-6 h-6 bg-yellow-100 border-2 border-yellow-500 rounded transform rotate-45 mr-2">
                    </div>
                    <span className="text-sm">Inventory/WIP</span>
                  </div>
                </div>
                
                <h3 className="font-semibold mb-2">Waste Categories</h3>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  {Object.entries(wasteIcons).map(([type, info]) => (
                    <div key={type} className="flex items-center p-2 border rounded">
                      <div className={`w-6 h-6 ${info.color} rounded-full flex items-center justify-center mr-2`}>
                        {info.icon}
                      </div>
                      <span className="text-sm">{info.name}</span>
                    </div>
                  ))}
                </div>
                
                <h3 className="font-semibold mb-2">Improvement Categories</h3>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  {Object.entries(improvementIcons).map(([type, info]) => (
                    <div key={type} className="flex items-center p-2 border rounded">
                      <div className={`w-6 h-6 ${info.color} rounded-full flex items-center justify-center mr-2`}>
                        {info.icon}
                      </div>
                      <span className="text-sm">{info.name}</span>
                    </div>
                  ))}
                </div>
                
                <h3 className="font-semibold mb-2">Value Stream States</h3>
                <div className="space-y-2 text-sm mb-4">
                  <div>
                    <span className="font-medium">Current State:</span> Shows the existing process with actual metrics
                    and highlights bottlenecks and inefficiencies.
                  </div>
                  <div>
                    <span className="font-medium">Improved State:</span> Shows the proposed short-term improvements
                    focusing on RFID implementation and layout optimization.
                  </div>
                  <div>
                    <span className="font-medium">Ideal State:</span> Shows the fully optimized future state with
                    complete automation and supplier integration.
                  </div>
                </div>
                
                <div className="text-center mt-6 text-sm text-gray-500">
                  Developed as part of Lean Six Sigma analysis for SimplePharma
                </div>
              </div>
              
              <div className="p-4 border-t">
                <button 
                  onClick={() => setShowInfoModal(false)}
                  className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      };
      
      // Effect to calculate connection lines after mount/resize
      React.useEffect(() => {
        const calculateLines = () => {
          const suppliers = processes.filter(p => p.type === 'supplier');
          const receivingNode = processes.find(p => p.id === 'process-receiving');
          const mapContainer = mapContainerRef.current;

          if (!receivingNode || !mapContainer) {
            console.log("Missing receiving node or map container ref");
            setConnectionStyles([]); // Clear styles if container not ready
            return;
          }

          const containerWidth = mapContainer.offsetWidth;
          const containerHeight = mapContainer.offsetHeight;
          
          if (containerWidth === 0 || containerHeight === 0) {
             console.log("Container dimensions are zero.");
             setConnectionStyles([]); // Clear styles if dimensions are zero
             return;
          }

          const styles = suppliers.map(supplier => {
            // Calculate pixel coordinates (center points)
            const x1 = (supplier.position.x / 100) * containerWidth;
            const y1 = (supplier.position.y / 100) * containerHeight;
            const x2 = (receivingNode.position.x / 100) * containerWidth;
            const y2 = (receivingNode.position.y / 100) * containerHeight;

            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI); // Angle in degrees

            console.log(`Line ${supplier.id}: (${x1},${y1}) to (${x2},${y2}), len: ${length}, angle: ${angle}`);


            return {
              key: `conn-${supplier.id}-receiving`,
              style: {
                position: 'absolute', // Ensure position is absolute here too
                left: `${x1}px`,
                top: `${y1}px`,
                width: `${length}px`,
                height: '2px', // Explicit height
                backgroundColor: '#888', // Explicit color
                transform: `rotate(${angle}deg)`,
                transformOrigin: '0 50%', // Explicit origin
                zIndex: 5 // Explicit z-index
              }
            };
          });
          setConnectionStyles(styles);
        };

        calculateLines(); // Calculate on mount

        // Optional: Recalculate on window resize
        window.addEventListener('resize', calculateLines);
        return () => window.removeEventListener('resize', calculateLines);

      }, [processes]); // Rerun if processes data changes (though unlikely needed here)


      // Function to render connection lines from state
      const renderConnections = () => {
        console.log("Rendering connections:", connectionStyles);
        return connectionStyles.map(line => (
          <div 
            key={line.key} 
            className="connection-line" // Keep class for potential base styles
            style={line.style} // Apply calculated styles
          ></div>
        ));
      };

      // Update metrics based on view mode
      React.useEffect(() => {
        if (viewMode === 'improved') {
          setMetrics({
            totalLeadTime: 59.9,
            valueAddedTime: 10.8,
            processCycleEfficiency: 18.0,
            accuracyRate: 92.5
          });
        } else if (viewMode === 'ideal') {
          setMetrics({
            totalLeadTime: 34.3,
            valueAddedTime: 9.9,
            processCycleEfficiency: 28.9,
            accuracyRate: 99.5
          });
        } else {
          setMetrics({
            totalLeadTime: 85.7,
            valueAddedTime: 12.4,
            processCycleEfficiency: 14.5,
            accuracyRate: 76.5
          });
        }
      }, [viewMode]);
      
      return (
        <div className="flex flex-col h-screen bg-gray-100">
          {/* Header */}
          <header className="bg-blue-700 text-white p-4">
            <div className="flex items-center justify-between">
              <h1 className="text-xl font-bold">SimplePharma Value Stream Map</h1>
              <div className="flex items-center space-x-4">
                <button 
                  onClick={() => setShowInfoModal(true)}
                  className="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded"
                >
                  <span>Info</span>
                </button>
              </div>
            </div>
          </header>
          
          {/* Control Bar */}
          <div className="bg-white shadow p-3 flex flex-wrap justify-between items-center gap-2">
            {/* View Mode Selector */}
            <div className="flex rounded overflow-hidden border">
              {['current', 'improved', 'ideal'].map(mode => (
                <button
                  key={mode}
                  className={`px-4 py-1 ${viewMode === mode ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                  onClick={() => setViewMode(mode)}
                >
                  {mode.charAt(0).toUpperCase() + mode.slice(1)}
                </button>
              ))}
            </div>
            
            {/* Metrics */}
            <div className="flex flex-wrap gap-3">
              <div className="bg-blue-50 px-3 py-1 rounded border border-blue-200">
                <span className="text-xs text-gray-500">Lead Time</span>
                <div className="text-sm font-medium">{metrics.totalLeadTime} hours</div>
              </div>
              <div className="bg-blue-50 px-3 py-1 rounded border border-blue-200">
                <span className="text-xs text-gray-500">Value-Added Time</span>
                <div className="text-sm font-medium">{metrics.valueAddedTime} hours</div>
              </div>
              <div className="bg-blue-50 px-3 py-1 rounded border border-blue-200">
                <span className="text-xs text-gray-500">Process Efficiency</span>
                <div className="text-sm font-medium">{metrics.processCycleEfficiency}%</div>
              </div>
              <div className="bg-blue-50 px-3 py-1 rounded border border-blue-200">
                <span className="text-xs text-gray-500">Accuracy Rate</span>
                <div className="text-sm font-medium">{metrics.accuracyRate}%</div>
              </div>
            </div>
          </div>
          
          {/* Value Stream Map */}
          <div className="flex-1 overflow-auto relative p-4">
            {/* Added map-container-inner class and ref */}
            <div 
              ref={mapContainerRef} 
              className="rounded-lg border bg-white w-full relative map-container-inner" 
              style={{ height: '600px', padding: '20px', overflow: 'hidden' }} // Added overflow hidden just in case
            >
              
              {/* Render connection lines */}
              {renderConnections()}

              {/* Render process nodes */}
              {processes.map(process => {
                const processDetails = getProcessDetails(process);
                const colorClass = getProcessColor(processDetails);
                const style = { 
                  left: `${process.position.x}%`, 
                  top: `${process.position.y}%` 
                };
                
                if (process.type === 'inventory') {
                  return (
                    <div 
                      key={process.id}
                      data-process-id={process.id} // Added data attribute
                      className={`inventory-node ${colorClass} border-2`}
                      style={style}
                      onClick={() => handleProcessClick(process)}
                    >
                      <div className="inventory-node-content">
                        <div className="text-xs font-medium text-center">{process.name}</div>
                      </div>
                      {createWasteIcons(process)}
                      {createImprovementIcons(process)}
                    </div>
                  );
                }
                
                return (
                  <div 
                    key={process.id}
                    data-process-id={process.id} // Added data attribute
                    className={`process-node ${colorClass} border-2`}
                    style={style}
                    onClick={() => handleProcessClick(process)}
                  >
                    <div className="text-sm font-medium mb-1">{processDetails.name}</div>
                    {processDetails.metrics && processDetails.metrics.oeeUtilization && (
                      <div className="text-xs">OEE: {processDetails.metrics.oeeUtilization}%</div>
                    )}
                    
                    {/* Waste icons for process nodes */}
                    {createWasteIcons(process)}
                    
                    {/* Improvement icons for process nodes */}
                    {createImprovementIcons(process)}
                  </div>
                );
              })}
              
              {/* Timeline bar at the bottom */}
              <div className="absolute bottom-4 left-10 right-10 h-16 border-t border-gray-300">
                <div className="flex justify-between px-4">
                  <div className="text-sm text-gray-500">
                    Total Lead Time: {metrics.totalLeadTime} hours
                  </div>
                  <div className="text-sm text-gray-500">
                    Process Cycle Efficiency: {metrics.processCycleEfficiency}%
                  </div>
                </div>
                
                {/* Value-Added Time bar */}
                <div className="h-8 mt-4 relative">
                  <div className="absolute top-0 left-0 right-0 h-4 bg-gray-200 rounded"></div>
                  <div 
                    className="absolute top-0 left-0 h-4 bg-green-500 rounded"
                    style={{ width: `${(metrics.valueAddedTime / metrics.totalLeadTime) * 100}%` }}
                  ></div>
                  <div className="absolute top-6 left-0 text-xs text-gray-500">
                    Value-Added: {metrics.valueAddedTime} hours
                  </div>
                  <div className="absolute top-6 right-0 text-xs text-gray-500">
                    Non-Value-Added: {(metrics.totalLeadTime - metrics.valueAddedTime).toFixed(1)} hours
                  </div>
                </div>
              </div>
              
              {/* Process details panel */}
              {renderProcessDetails()}
            </div>
          </div>
          
          {/* Info Modal */}
          {renderInfoModal()}
          
          {/* Legend bar at bottom */}
          <div className="bg-white border-t p-2">
            {viewMode === 'current' ? (
              <div className="flex flex-wrap gap-2 justify-center">
                {Object.entries(wasteIcons).map(([type, info]) => (
                  <div key={type} className="flex items-center gap-1 text-xs px-2 py-1 rounded border">
                    <span className={`inline-block ${info.color} rounded-full p-1`}>{info.icon}</span>
                    <span>{info.name}</span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="flex flex-wrap gap-2 justify-center">
                {Object.entries(improvementIcons).map(([type, info]) => (
                  <div key={type} className="flex items-center gap-1 text-xs px-2 py-1 rounded border">
                    <span className={`inline-block ${info.color} rounded-full p-1`}>{info.icon}</span>
                    <span>{info.name}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Render app
    try {
      // Update debug message
      document.getElementById('debug-container').innerText = 'React loaded, attempting to render app...';
      
      // Render the app
      ReactDOM.render(
        <ValueStreamMap />,
        document.getElementById('root')
      );
      
      // If successful, update debug message again
      setTimeout(() => {
        document.getElementById('debug-container').innerText = 'App rendered successfully!';
        // Hide the debug message after 5 seconds
        setTimeout(() => {
          const debugEl = document.getElementById('debug-container');
          if (debugEl